#!/usr/bin/env node
var processes = [];

require('./utils/findIndex');
var config = require('./config');
var processFlags = require('./utils/flags');
var promiseExec = require('./utils/promiseExec')(processes);
var music = require('./utils/music');
var git = require('./utils/git');

gitPushIt();

function gitPushIt() {
  var flagged = processFlags(config.getSongList());
  var configured = config(flagged.song);
  return git.login(promiseExec, flagged.args, configured)
    .then(pushIt(flagged.song, flagged.args, configured))
    .then(pushItSuccess)
    .catch(pushItFailure);
}

function pushIt(song, args, config) {
  return function() {
    return Promise.all([
      music.play(promiseExec, song, config),
      git.push(promiseExec, args, config),
      music.echoLyrics(config)
    ]);
  };
}

function pushItSuccess(output) {
  console.log(output[1]);
  process.exit();
}

function pushItFailure(err) {
  console.error(err.message || err);
  processes.forEach(function(child) {
    child.kill('SIGKILL');
  });
  process.exit(1);
}
